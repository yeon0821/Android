# Token

토큰 기반 시스템은 무상태. 즉 상태유지를 하지 않는다는 것이다. 

이 시스템에는 유저의 인증 정보를 서버나 세션에 담아주지 않는다.

이 개념 하나만으로 위에서 서술한 서버에서 유저의 인증 정보를 서버측에 담아둠으로 발생하는 많은 문제점들이 해소 된다.

세션이 존재하지 않으니, 유저들이 로그인 되어있는지 안되어있는지 신경도 쓰지 않으면서 서버를 손쉽게 확장 할 수 있다.

----

1. 유저가 아이디와 비밀번호로 **로그인**을 합니다
2. 서버측에서 해당 **계정정보를 검증**합니다.
3. 계정정보가 정확하다면, 서버측에서 유저에게 *signed* **토큰을 발급**해줍니다.
   *여기서 signed 의 의미는 해당 토큰이 서버에서 정상적으로 발급된 토큰임을 증명하는 signature 를 지니고 있다는 것입니다*
4. 클라이언트 측에서 전달받은 **토큰을 저장**해두고, 서버에 요청을 할 때 마다, 해당 **토큰을 함께 서버에 전달**합니다.
5. 서버는 **토큰을 검증**하고, **요청에 응답**합니다.

---

## JWT이란?

사용자가 로그인을 하면 토큰을 주는데, 이 토큰을 서버가 기억하고 있지 않는다. (시간에 따라 바뀌는 어떤 상태값을 안 갖는 것 - stateless, 반대로 세션은 stateful)

- JWT 예시
- ![img](https://velog.velcdn.com/images%2Fsyoung125%2Fpost%2F22a71891-6193-4639-a997-448298dbb043%2Fimage.png)

암호화된 3가지 데이터를 이어붙인 형태(aaa.bbb.ccc)로 구성되어 있다.

#### JWT 구조

- **Header, Payload, Signature**의 3부분으로 이루어져 있다.
  Json 형태인 각 부분은 **Base64**로 인코딩 되어 표현된다. 각 부분을 이어주기 위해 .구분자를 반환한다.
- Base64는 암호화된 문자열이 아니고, 같은 문자열에 대해 항상 같은 문자열을 반환한다



![JWT토큰이란, 장단점, 구현 - undefined - undefined - JWT 구조](https://blog.kakaocdn.net/dn/bCnPkT/btq9ynF8GpN/NCmsYv3wvGNxQWylRLJti0/img.png)



#### Header/ Payload/ Signature

1. **Header**

- Header 는 두가지의 정보를 지니고 있다.
- typ: 토큰의 타입을 지정. ex)JWT
- alg: 해싱 알고리즘을 지정합니다. 해싱 알고리즘으로는 보통 HMAC SHA256 혹은 RSA 가 사용되며, 이 알고리즘은, 토큰을 검증 할 때 사용되는 signature 부분에서 사용.

```
{ 
 "alg": "HS256",
 "typ": JWT
}
```

 

1. **Payload**

- Payload 부분에는 토큰에 담을 정보가 들어있습니다. 여기에 담는 **정보의 한 ‘조각’ 을 클레임(Claim)** 이라고 부르고, 이는 Json(Key/Value) 형태의 한 쌍으로 이뤄져있습니다. 토큰에는 여러개의 클레임들을 넣을 수 있다.

- 클레임 의 종류는 다음과 같이 크게 세 분류로 나뉘어져있다:

  1) **등록된 (registered) 클레임**
     iss: 토큰 발급자 (issuer)
     sub: 토큰 제목 (subject)
     aud: 토큰 대상자 (audience)
     exp: 토큰의 만료시간 (expiraton),
     시간은 NumericDate 형식으로 되어있어야 하며
     (예: 1480849147370) 언제나 현재 시간보다 이후로 설정되어있어야한다.

  nbf: Not Before 를 의미하며, 토큰의 활성 날짜와 비슷한 개념.
  여기에도 NumericDate 형식으로 날짜를 지정하며,
  이 날짜가 지나기 전까지는 토큰이 처리되지 않는다.
  iat: 토큰이 발급된 시간 (issued at), 이 값을 사용하여 토큰의 age 가 얼마나 되었는지 판단 할 수 있다.
  jti: JWT의 고유 식별자로서, 주로 중복적인 처리를 방지하기 위하여 사용.
    일회용 토큰에 사용하면 유용.

  2. **공개(public)클레임**
     공개 클레임들은 충돌이 방지된 (collision-resistant) 이름을 가지고 있어야 한다.
     충돌을 방지하기 위해서는, 클레임 이름을 URI 형식으로 짖는다.
     등록된 (registered) 클레임
     공개 (public) 클레임
     비공개 (private) 클레임

```
{
   "https://velopert.com/jwt_claims/is_admin": true
}
```


### 3. Signature

- 서명(Signature)은 토큰을 인코딩하거나 유효성 검증을 할 때 사용하는 고유한 암호화 코드
- 서명(Signature)은 위에서 만든 헤더(Header)와 페이로드(Payload)의 값을 각각 BASE64로 인코딩하고, 인코딩한 값을 비밀 키를 이용해 헤더(Header)에서 정의한 알고리즘으로 해싱을 하고, 이 값을 다시 BASE64로 인코딩하여 생성.

-----

### 세션을 대체하지 못하는 이유

JWT는 세션처럼 모든 사용자들의 상태를 기억하고 있지 않다. 따라서 기억하는 대상들의 상태를 언제든 제어할 수 있지 않다. 예를 들어, 세션을 이용한 경우 한 기기에서만 로그인 가능한 서비스를 만들고 싶을 때, pc에서 로그인 하면 핸드폰에서의 세션 값은 사용못하게 하는 등 제어할 수 있다.

반면 JWT는 이미 줘버린 토큰을 뺏을 수 도 없다. 해커에게 토큰을 빼앗겨도 토큰을 무효화할 방법도 없다.

